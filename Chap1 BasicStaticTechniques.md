
# Portable Excutable File Format

# Linked Libraries and Functions
* One of the most information of an executable is the list of functions that it **imports**. It allows us to guess what the program does;
* Code libraries can be connected to the main executable by **linking**;
* Code libraries can be linked **statically**, at runtime, or **dynamically**;
## Static, Runtime, and Dynamic Linking
* Static linking is the **least** commonly used method of linking libraries;
  * Makes the executables grow in size;
  * Difficult to differentiate between statically linked code and the executable’s own code;
* **Runtime linking** is commonly used in malware;
  * Executables that use runtime linking connect to libraries only when that function is needed;
* Several Windows functions allow programmers to import linked functions **not listed** in a program’s file header:
  * Most commonly used: LoadLibrary, GetProcAddress;
    * Can access any function in any library on the system;
  * Also used: LdrGetProcAddress, LdrLoadDll;
* **Dynamic linking** is the **most common** and the most interesting for malware analysts.
  * When libraries are dynamically linked, the host OS searches for the necessary libraries when the program is **loaded**. 
  * When the program calls the linked library function, that function executes **within the library**.

## Exploring Dynamically Linked Functions with Dependency Walker
* **DependencyWalker** program lists dynamically linked functions in an executable;
* Common DLLs:
  * Kernel32.dll: **core functionality**, such as manipulation of **memory, files, and hardware**;
  * Advapi32.dll: **advanced core Windows components** such as **Service Manager and Registry**;
  * User32.dll: **user-interface** components, such as buttons, scoll bars.
  * Gdi32.dll: displaying and manipulating **graphics**;
  * Ntdll.dll: interface to Windows kernel;
    * If an executable imports this file, means that the author intended to use functionality not available to Windows programs, such as hiding functionality or manipulating processes;
  * WSock32.dll and Ws_32.dll: networking, such as performing network-related tasks;
  * Wininet.dll: higher-level networking functions that implements such as FTP, HTTP and NTP;
* Function Naming Conventions:
  * Ex - When Microsoft updates a function and the new function is incompatible with the old one, Microsoft continues to support the old function. The new function is given the same name as the old function, with an added Ex suffix. Functions that have been significantly updated twice have two Ex suffixes in their names.

## Imported Functions
* information about specific functions used by an executable.

## Exported Functions
* DLLs and EXEs export functions to interact with other program and code. Exported functions are **most common** in DLLs;
* The **name** of exported functions provides useful information:
  * The presence of an exported function called ServiceMain tells you that the malware runs as part of a service.
  * Functions can have any name even thourgh it is same as official name;


# Static Analysis in Practice
## PotentialKeylogger.exe: An unPacked Executable
* Seeing many imports means file not packed;