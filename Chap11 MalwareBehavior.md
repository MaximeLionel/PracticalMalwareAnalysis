# Downloaders and Launchers
* Downloaders: **download** another piece of malware from malware and execute it on local system.
  * often packaged with an **exploit**.
  * often use **URLDownloadtoFileA** and **WinExec**.
* Launcher: an executable that **installs** malware for immediate or future convert execution.
# Backdoors
* backdoors: provides an attacker with remote access to a victim's machine and is the most common type of malware.
* backfoors communicate with internet over numerous ways:
  * common method: HTTP protocol over port 80.
    * HTTP is the most commonly used protocol for outgoing network traffic.
* backfoors functions: the ability to manipulate registry keys, enumerate display windows, create directories, search files.
## Reverse Shell
* reverse shell: a **connection** that originates from an infected machine and provides attackers **shell access** to that machine.
* reverse shell is stand-alone malware and components of sophisticated backdoors.
* in reverse shell, attackers can **execute commands** as on local machine.
### Netcat Reverse Shells
### Windows Reverse Shells
* 2 simple malware code implementations for reverse shells on **Windows** using cmd.exe: **basic and multithreaded**.
  * basic method: 
    * invoke CreateProcess and manipulate STARTUPINFO structure.
    * a socket is is created and a connection to a remote server is established.
    * the socket is tied to the standard stream (std input, std output, std error) for cmd.exe.
    * CreateProcess runs cmd.exe with no window.
  * multithreaded method:
    * involve: creations of a socket, 2 pipes, and 2 threads.
    * theory: manipulate or encode the data coming in or going out over the socket.
    * CreatePipe is used to tie read and write ends to a pipe, such as stdin and stdout.
    * CreateProcess is used to tie standard streams to pipes instead of sockets.
    * the malware spawns 2 threads:
      * reading from stdin pipe and writing to the socket.
      * reading from the socket and writing to stdout pipe.
      * the 2 threads manipulate the data using data encoding.
## RATs
* RAT - remote access tool is used to remotely manage a computer.
* Typically over port 80 and 443.
## Botnets
* botnet is a collection of compromised hosts, known as **zombies**, which are controlled by **botnet controller**.
* goal of botnet is to compromise as many hosts as possible to create a large network of zombies.
## RATs and Botnets compared
* Botnets can infect and control millions of hosts while RATs control far fewer hosts.
* RATs are used in targeted attacks while Botnets are used in mass attacks.

# Credential Stealers
* 3 types of malware:
  * programs that wait for a user to log in.
  * programs that dump information stored in Windows.
  * programs that log keystrokes.
## GINA Interception
* GINA - Graphical Identification and Authentication.
* msgina.dll is loaded by Winlogon executable during logon process.
* key location: HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\GinaDLL.
* suppose fsgina.dll is GINA interception malware:
  ![GINA](./Figure11_2.JPG)
  * fsgina.dll intercepts the communication between Winlogon and msgina.dll.
  * malware must contain **all export functions** required by GINA, which are prefixed with 'Wlx'.
  * **WlxLoggedOutSAS** export of fsgina.dll:
  ```
    100014A0 WlxLoggedOutSAS 
    100014A0 push esi
    100014A1 push edi
    100014A2 push offset aWlxloggedout_0 ; "WlxLoggedOutSAS"
    100014A7 call Call_msgina_dll_function
    ...
    100014FB push eax ; Args
    100014FC push offset aUSDSPSOpS ;"U: %s D: %s P: %s OP: %s"
    10001501 push offset aDRIVERS ; "drivers\tcpudp.sys"
    10001503 call Log_To_File
  ```
  * one example of the export list:
  ```
    30,WlxActivateUserShell,.text:100012B0,-,-,-,-,-
    31,WlxDisconnectNotify,.text:100012C0,-,-,-,-,-
    32,WlxDisplayLockedNotice,.text:100012D0,-,-,-,-,-
    33,WlxDisplaySASNotice,.text:100012E0,-,-,-,-,-
    34,WlxDisplayStatusMessage,.text:100012F0,-,-,-,-,-
    35,WlxGetConsoleSwitchCredentials,.text:10001300,-,-,-,-,-
    36,WlxGetStatusMessage,.text:10001310,-,-,-,-,-
    37,WlxInitialize,.text:10001320,-,-,-,-,-
    38,WlxIsLockOk,.text:10001330,-,-,-,-,-
    39,WlxIsLogoffOk,.text:10001340,-,-,-,-,-
    40,WlxLoggedOnSAS,.text:10001350,-,-,-,-,-
    41,WlxLoggedOutSAS,.text:100014A0,-,-,-,-,-
    42,WlxLogoff,.text:10001360,-,-,-,-,-
    43,WlxNegotiate,.text:10001370,-,-,-,-,-
    44,WlxNetworkProviderLoad,.text:10001380,-,-,-,-,-
    45,WlxReconnectNotify,.text:10001390,-,-,-,-,-
    46,WlxRemoveStatusMessage,.text:100013A0,-,-,-,-,-
    47,WlxScreenSaverNotify,.text:100013B0,-,-,-,-,-
    48,WlxShutdown,.text:100013C0,-,-,-,-,-
    49,WlxStartApplication,.text:100013D0,-,-,-,-,-
    50,WlxWkstaLockedSAS,.text:100013E0,-,-,-,-,-
  ```
## Hash Dumping
* attackers grab the dumped hash to **crack offline** or use them in **a pass-the-hash attack**.
  * **a pass-the-hash attack** use LM and NTLM hashes to authenticate to a remote host without decypting or cracking.
* Pwdump and the Pash-the-Hash (PTH) toolkit are the tools providing hash dumping, which are open-sourced.
* Pwdump:
  * Pwdump can output LM and NTLM password hashes from **Security Account Manager (SAM)**.
  * Pwdump works by injecting DLL inside Local Security Authority Subsystem Services (LSASS - lsass.exe).
  * Standard pwdump injects lsaext.dll into lsass.exe then calls GetHash to perform hash extraction.
  * attackers usually avoid call GetHash directly by using GetProcAddress to make it invisible.
  ```
    1000123F push offset LibFileName ; "samsrv.dll" 
    10001244 call esi ; LoadLibraryA
    10001248 push offset aAdvapi32_dll_0 ; "advapi32.dll" 
    ...
    10001251 call esi ; LoadLibraryA
    ...
    1000125B push offset ProcName ; "SamIConnect"   // used to connect to SAM
    10001260 push ebx ; hModule
    10001265 call esi ; GetProcAddress
    ...
    10001281 push offset aSamrqu ; "SamrQueryInformationUser"
    10001286 push ebx ; hModule
    1000128C call esi ; GetProcAddress
    ...
    100012C2 push offset aSamigetpriv ; "SamIGetPrivateData" // used to extract hashes
    100012C7 push ebx ; hModule
    100012CD call esi ; GetProcAddress
    ...
    100012CF push offset aSystemfuncti ; "SystemFunction025" // to decrypt hashes
    100012D4 push edi ; hModule
    100012DA call esi ; GetProcAddress
    100012DC push offset aSystemfuni_0 ; "SystemFunction027" // to decrypt hashes
    100012E1 push edi ; hModule
    100012E7 call esi ; GetProcAddress
  ```
* PSH Toolkit:
  * whosthere-alt of the Toolkit dumps SAM by injecting into lsass.exe.
  ```
    10001119 push offset LibFileName ; "secur32.dll"
    1000111E call ds:LoadLibraryA
    10001130 push offset ProcName ; "LsaEnumerateLogonSessions" // a list of locally unique identifiers
    10001135 push esi ; hModule
    10001136 call ds:GetProcAddress 
    ...
    10001670 call ds:GetSystemDirectoryA
    10001676 mov edi, offset aMsv1_0_dll ;      \\msv1_0.dll
    ...
    100016A6 push eax ; path to msv1_0.dll
    100016A9 call ds:GetModuleHandleA
  ```
  * NlpGetPrimaryCredential is used to dump NT and LM hashes.
## Keystroke Logging
### Kernel-Based Keyloggers
* difficult to detect with user-mode applications.
* usually part of a rootkit and act as keyboard drivers bypassing user-space programs and protections.
### User-Space Keyloggers
* Hooking - SetWindowsHookEx: notify malware each time a key is pressed.
* Polling - GetAsyncKeyState and GetForegroundWindow: poll the state of the keys.
### Identifying Keyloggers in Strings Listings
* lists of strings:
  ```
    [Up]
    [Num Lock]
    [Down]
    [Right]
    [UP]
    [Left]
    [PageDown]
  ```

# Persistence Mechanisms
* once a malware access a system, it often looks to be there for a long time, known as **persistence**.
## The Windows Registry
* Persistence Registry key: HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run.
* Tools that search for persistent registry: Autoruns.
* ProcMon can monitor registry modifications.
### AppInit_DLLs
* AppInit_DLLs are loaded into every process that loads User32.dll.
* Registry Key: HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows.
### Winlogon Notify
* can hook malware to a particular Winlogon event, such as logon, logoff, startup, shutdown and lock screen.
* Notify value of registry key:
  ```
    HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\
  ```
### SvcHost DLLs
